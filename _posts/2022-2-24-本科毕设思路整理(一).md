---
layout: post
author: shopkeeper
categories: thesis gis
---

## beidou-grid-location-codec

- v1.1.0 -> v1.1.5

- 修复已知错误

- 重构参考、还原函数，优化计算速度

- 添加新功能：获取邻接网格、获取可参考网格范围

## 空间数据关联模型

分为三种节点，空间编码节点、POI 节点、属性节点。

- 空间编码节点分为第 1~4 级，如图所示

  ![](/assets/images/2022-2-24-本科毕设思路整理(一)-1.png)

  包含 3 个属性值：`name`、`type`、`level`。`name`为北斗网格编码值；`type`恒为字面量`"bgdlc"`；`level`为北斗网格位置码等级。对于任意一个`level`为`L`的节点，假设其所表示的网格为`C`，那么该节点对所有处于网格`C`中并且`level`为`L+1`的节点有`包含`关系。

- `level`为 4 的节点与处于其网格内的所有 POI 节点有`拥有`关系，如图所示

  ![](/assets/images/2022-2-24-本科毕设思路整理(一)-2.png)

  进行空间范围检索时，需要首先检索目标网格对应的空间编码节点，再通过空间编码节点检索其对应的 POI 节点

- 目前的数据库中共有空间编码节点 4364 个，其中四级编码节点有 4275 个；有 POI 节点 487818 个，平均一个四级空间编码节点下有 120 个 POI 节点。

- **以下方案已废弃，原因参照我在StackOverflow上的一个提问 [链接](https://stackoverflow.com/questions/71230702/efficiency-of-string-equals-or-starts-with-in-neo4j)**

- ~~空间编码节点包含三个属性值：`name`、`type`、`level`，name 为编码值，且选取第四级北斗网格编码，网格大小为 1′×1′，理由是赤道处第四级网格的大小约为 1.85km×1.85km，与本系统最小空间搜索粒度同量级；`type`恒为字面量`bgdlc`；`level`恒为数字`4`，表示所有空间编码均为第四级编码。~~
- ~~关于空间编码节点的`level`属性的说明：完整的空间编码节点应该是具有层级的，由`level-1`级节点关联到`level`级节点，如下图所示~~

  ~~本模型中该属性恒定为`4`，理由是不需要 1~3 级的空间编码节点即可直接查询到第四级的空间编码节点，因为第四级的编码必定是以其上级编码为开头的，在 neo4j 查询中使用`STARTS WITH`语法即可。~~

- ~~数据处理完成并导入后，共有 4275 个空间编码节点，487818 个 POI 节点，平均一个空间编码节点下关联 120 个 POI 节点。~~

## 空间范围搜索

1. 矩形搜索

   这是一种由用户决定搜索范围的搜索。需要将用户指定的矩形范围转化为需要检索的北斗网格集合。

   一个简朴的转化思路如下：

   我们只需要矩形框一条对角线上的两个点，计算其北斗网格位置码（保留到第四级即可）为`C1`和`C2`，计算这两个坐标的编码的公共前缀，令公共前缀表示一个`level-1`级的网格（意味着该矩形被这个网格包含），将`C1`和`C2`缩短至`level`级得到`C1'`和`C2'`，我们需要检索的北斗网格集合为从`C1'`到`C2'`的矩阵中的所有网格。

   例如图所示的一个矩形框：

   ![](/assets/images/2022-2-24-本科毕设思路整理(一)-3.png)

   西北角`N50H05152`和东南角`N50H05171`，计算其公共前缀长度为`N50H051`是一个三级的网格。此时`N50H05152`和`N50H05171`已经是第四级的网格了，那么需要检索的网格就是上图中绿色的六个网格。

2. 圆形搜索

   这是一种由用户提供搜索中心和搜索半径的搜索。

   这种搜索需要考虑很重要的一点：不同经纬度上的同一等级的网格长度大小并不同，例如一个第四级网格（1′×1′）在赤道上的大小约为 1.85KM×1.85KM，但是在高纬度地区就要远远小的多。

   因此首先需要定义一个函数`getGridSize(centre: LngLat, level: number)`，用于获取某一点`centre`经纬度上的`level`级的网格的大小。

   对于用户指定的搜索中心`C`和搜索半径`R`，首先计算出`C`处从 1 至 4 级的网格的大小`L1`、`L2`、`L3`、`L4`，找到最小的`Li`使得`Li`大于`R`，此时的`Li`的等级`i`就是检索的网格的等级。这一步可以保证搜索范围的圆一定在以`C`所在的网格为中心的 3×3 的九个网格内。

   假设这九个网格分别为

   ```
   (X-1, Y+1) (X, Y+1) (X+1, Y+1)
   (X-1, Y)   (X, Y)   (X+1, Y)
   (X-1, Y-1) (X, Y-1) (X+1, Y-1)
   ```

   首先`(X, Y)`一定是需要检索的网格，邻接的其它八个网格需要分别计算如下图所示的八条线段长度，如果某条线段小于搜索半径`R`，那么其对应的网格也需要进行检索。

   ![](/assets/images/2022-2-24-本科毕设思路整理(一)-4.png)

   假如`R`大于第一级网格的大小，那么对这个圆的外接矩形进行矩形搜索。
